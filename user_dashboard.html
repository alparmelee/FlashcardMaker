<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Dashboard - CramCraft</title>
  <link rel="icon" type="image/png" href="images/icon.png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="stylesheet.css" />
  <style>
    /* Basic styles for the set card actions */
    .set-card {
      position: relative;
    }

    .set-actions {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .set-rating {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .star {
      font-size: 1.3em;
      color: #ccc;
      cursor: pointer;
      transition: color 0.2s;
    }

    .star.active {
      color: gold;
    }


    .set-actions button {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.2s ease;
    }

    .set-actions .edit-set-btn {
      background-color: #007bff;
      color: white;
    }

    .set-actions .edit-set-btn:hover {
      background-color: #0056b3;
    }

    .set-actions .delete-set-btn {
      background-color: #dc3545;
      color: white;
    }

    .set-actions .delete-set-btn:hover {
      background-color: #c82333;
    }
  </style>
</head>

<body class="user-dashboard-page">
  <nav class="top-nav">
    <div class="top-nav-inner">
      <div class="nav-logo"><a href="index.html">CramCraft</a></div>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="create.html">Create</a></li>
        <li><a href="user_dashboard.html">Dashboard</a></li>
        <li><a href="search_page.html">Search</a></li>
        <li><a href="about.html">About</a></li>
      </ul>
      <div class="user-status" style="display: none;">
        <span id="welcome-msg">Welcome, DemoUser!</span>
        <a href="#" id="logout-btn" class="logout-button">Logout</a>
      </div>
    </div>
  </nav>

  <div class="content-wrapper" id="dashboard-content" style="display: none;">
    <h1>My Dashboard</h1>
    <p class="user-greeting" id="user-greeting-msg"></p>
    <a href="create.html" class="create-new-set-btn">+ Create New Set</a>

    <h2>Your Sets</h2>
    <div class="sets-grid"></div>
  </div>

  <div id="flashcard-set-container" class="hidden">
    <button onclick="backToDashboard()">‚Üê Back to Sets</button>
    <div class="study-modes">
      <button class="mode-button active" id="mode-flashcards">Flashcards</button>
      <button class="mode-button" id="mode-quiz">Quiz</button>
      <button class="mode-button" id="mode-list">List</button>
      <button class="mode-button" id="mode-print">Print</button>
    </div>
    <div id="flashcard-view" class="hidden">[...]</div>
    <div id="quiz-view" class="hidden">[...]</div>
    <div id="list-view" class="hidden">[...]</div>
  </div>

  <script type="module">
    import {createClient} from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabaseUrl = 'https://uxytxzliqxpinajccvbu.supabase.co';
    const supabaseKey =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4eXR4emxpcXhwaW5hamNjdmJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1Nzg4MjgsImV4cCI6MjA2NDE1NDgyOH0.1RE6lzGdoj7kfaExaJrBUap9TwuQs5d3TxLarQaweb8';
    const supabase = createClient(supabaseUrl, supabaseKey, {
      auth: {
        storage: localStorage,
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: false,
      },
    });

    async function loadUserDashboard() {
      try {
        let retries = 3;
        let session = null;

        while (retries-- > 0) {
          const {data: sessionResult} = await supabase.auth.getSession();
          session = sessionResult.session;
          if (session) break;
          await new Promise((res) => setTimeout(res, 300));
        }

        if (!session || !session.user) {
          window.location.href = 'login.html';
          return;
        }

        const user = session.user;
        const accessToken = session.access_token;
        let edgeResp = null;

        // Call Edge Function to create profile
        if (accessToken) {
          const savedUsername = localStorage.getItem('username');
          edgeResp = await fetch('https://uxytxzliqxpinajccvbu.supabase.co/functions/v1/user-created-handler', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${accessToken}`,
            },
            body: JSON.stringify({
              user: {
                id: user.id,
                email: user.email,
                username: savedUsername,
              },
            }),
          });

          const result = await edgeResp.json();
          // Optionally handle result/error
        }

        // Fetch user profile
        let profile, profileError;
        ({data: profile, error: profileError} = await supabase
          .from('profiles')
          .select('username')
          .eq('user_id', user.id)
          .single());

        if (profileError) {
          await new Promise((res) => setTimeout(res, 800));
          ({data: profile, error: profileError} = await supabase
            .from('profiles')
            .select('username')
            .eq('user_id', user.id)
            .single());
        }

        if (profileError) {
          document.getElementById('welcome-msg').textContent = `Welcome, ${user.email}`;
          document.getElementById('user-greeting-msg').textContent = `Here are your flashcard sets, ${user.email}.`;
        } else {
          document.getElementById('welcome-msg').textContent = `Welcome, ${profile.username}!`;
          document.getElementById('user-greeting-msg').textContent = `Here are your flashcard sets, ${profile.username}.`;
        }

        document.querySelector('.user-status').style.display = 'flex';
        document.getElementById('dashboard-content').style.display = 'block';

        const {data: sets, error: setsError} = await supabase
          .from('flashcard_sets')
          .select(`
            id,
            title,
            category,
            flashcards(count)
          `)
          .eq('user_id', user.id)
          .order('created_at', {ascending: false});

        if (setsError) {
          console.error('Error fetching sets:', setsError.message);
        } else {
          const grid = document.querySelector('.sets-grid');
          grid.innerHTML = '';
          sets.forEach((set) => {
            const termCount = set.flashcards[0] ? set.flashcards[0].count : 0;
            const card = document.createElement('div');
            card.className = 'set-card';
            card.innerHTML = `
              <h3>${set.title}</h3>
                <p>${set.category ? set.category : 'No Category'}</p>
                <p>${termCount} terms</p>
            <div class="set-actions">
              <div class="set-rating" data-set-id="${set.id}">
                ${[1, 2, 3, 4, 5].map(i => `<span class="star" data-value="${i}">&#9733;</span>`).join('')}
              </div>
              <div>
                <button class="edit-set-btn" data-set-id="${set.id}">Edit</button>
                <button class="delete-set-btn" data-set-id="${set.id}">Delete</button>
              </div>
            </div>
            `;

            // Event listener for the whole card to navigate to flashcard_set.html
            card.addEventListener('click', (e) => {
              // Prevent navigation if delete button is clicked
              if (e.target.classList.contains('delete-set-btn')) return;
              window.location.href = `flashcard_set.html?set_id=${set.id}`;
            });

            // Add event listener for the edit button
            card.querySelector('.edit-set-btn').addEventListener('click', (e) => {
              e.stopPropagation(); // Prevent the parent card's click listener from firing
              const setId = e.target.getAttribute('data-set-id');
              window.location.href = `create.html?set_id=${setId}`;
            });

            grid.appendChild(card);
            const stars = card.querySelectorAll('.set-rating .star');
            stars.forEach((star, index) => {
              star.addEventListener('click', () => {
                const ratingValue = index + 1;
                const allStars = star.parentElement.querySelectorAll('.star');
                allStars.forEach((s, i) => {
                  s.classList.toggle('active', i < ratingValue);
                });

                // Optional: send rating to database (using Supabase or AJAX)
                console.log(`Rated set ${set.id} with ${ratingValue} stars`);
              });
            });

          });
        }
      } catch (err) {
        console.error('Error loading dashboard:', err);
        window.location.href = 'login.html';
      }
    }

    // Call the dashboard load function on page load
    document.addEventListener('DOMContentLoaded', loadUserDashboard);

    // Logout button event listener
    document.addEventListener('click', async (e) => {
      if (e.target && e.target.id === 'logout-btn') {
        e.preventDefault();
        await supabase.auth.signOut();
        window.location.href = 'login.html';
      }
    });

    // Delete set button event listener (event delegation)
    document.addEventListener('click', async (e) => {
      if (e.target && e.target.classList.contains('delete-set-btn')) {
        e.preventDefault();
        const setId = e.target.getAttribute('data-set-id');
        if (!setId) return;

        const confirmed = confirm(
          'Are you sure you want to delete this set? This action cannot be undone and will also delete all associatedflashcards.'
        );
        if (!confirmed) return;

        try {
          // STEP 1: Delete associated flashcards FIRST
          const {error: deleteCardsError} = await supabase.from('flashcards').delete().eq('set_id', setId);

          if (deleteCardsError) {
            console.error('Failed to delete associated flashcards:', deleteCardsError.message);
            alert(
              'Could not delete all associated flashcards. Please check database permissions or try again. Attempting to delete theset itself.'
            );
            // You might choose to throw an error here to stop if card deletion is critical,
            // but proceeding to delete the set might be acceptable depending on your app logic.
          }

          // STEP 2: Then delete the flashcard set itself
          const {error: deleteSetError} = await supabase.from('flashcard_sets').delete().eq('id', setId);

          if (deleteSetError) {
            throw new Error('Failed to delete set: ' + deleteSetError.message);
          }

          alert('Flashcard set and its associated cards (if any) deleted successfully!');
          e.target.closest('.set-card').remove();
        } catch (err) {
          console.error('Error during delete operation:', err.message);
          alert('An error occurred during deletion: ' + err.message);
        }
      }
    });

    // Back to dashboard function
    function backToDashboard() {
      document.getElementById('dashboard-content').style.display = 'block';
      document.getElementById('flashcard-set-container').classList.add('hidden');
    }
    window.backToDashboard = backToDashboard;
  </script>

  <script>
    // View toggle logic for quiz/flashcards/list
    document.getElementById('mode-quiz').addEventListener('click', () => {
      document.getElementById('flashcard-view').classList.add('hidden');
      document.getElementById('list-view').classList.add('hidden');
      document.getElementById('quiz-view').classList.remove('hidden');
    });

    document.getElementById('mode-flashcards').addEventListener('click', () => {
      document.getElementById('quiz-view').classList.add('hidden');
      document.getElementById('list-view').classList.add('hidden');
      document.getElementById('flashcard-view').classList.remove('hidden');
    });

    document.getElementById('mode-list').addEventListener('click', () => {
      document.getElementById('quiz-view').classList.add('hidden');
      document.getElementById('flashcard-view').classList.add('hidden');
      document.getElementById('list-view').classList.remove('hidden');
    });
  </script>

</body>

</html>