<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Flashcard Sets - CramCraft</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="stylesheet.css" />
    <style>
        /* Add some basic styling for the new line if needed, for example: */
        .set-view-prompt {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px; /* Adds space above it */
            margin-bottom: 5px; /* Adds space below it */
        }
        /* Adjust other elements margin/padding as needed for new line */
        .set-card p {
            margin-bottom: 0; /* Adjust default paragraph margins if needed */
        }
    </style>
</head>
<body class="search-page">
    <nav class="top-nav">
        <div class="top-nav-inner">
            <div class="nav-logo"><a href="index.html">CramCraft</a></div>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="create.html">Create</a></li>
                <li><a href="user_dashboard.html">Dashboard</a></li>
                <li><a href="search_page.html">Search</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
            <div class="auth-buttons">
                <div class="user-status" style="display: none;"></div>
                <a href="login.html" class="btn">Login</a>
                <a href="signup.html" class="btn">Signup</a>
            </div>
        </div>
    </nav>

    <div class="main-content-wrapper search-content">
        <h1>Search Flashcard Sets</h1>

        <div class="search-controls">
            <input type="text" id="search-input" placeholder="Search for sets by title..." />
            <button id="search-button">Search</button>
        </div>

        <div class="filter-controls">
            Filter by Category:
            <label><input type="radio" name="category-filter" value="All" checked> All</label>
            <label><input type="radio" name="category-filter" value="Math"> Math</label>
            <label><input type="radio" name="category-filter" value="Science"> Science</label>
            <label><input type="radio" name="category-filter" value="History"> History</label>
            <label><input type="radio" name="category-filter" value="Technology"> Technology</label>
            </div>

        <p id="set-count-info">Showing X sets.</p>
        <div class="sets-grid" id="search-results-grid">
            </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabaseUrl = 'https://uxytxzliqxpinajccvbu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4eXR4emxpcXhwaW5hamNjdmJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1Nzg4MjgsImV4cCI6MjA2NDE1NDgyOH0.1RE6lzGdoj7kfaExaJrBUap9TwuQs5d3TxLarQaweb8';
        const supabase = createClient(supabaseUrl, supabaseKey, {
            auth: {
                storage: localStorage,
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: false
            }
        });

        // Function to update auth UI (similar to your dashboard/create pages)
        async function updateAuthUI() {
            const { data: { session } } = await supabase.auth.getSession();
            const authButtonsDiv = document.querySelector('.auth-buttons');
            if (session) {
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('username')
                    .eq('user_id', session.user.id)
                    .single();
                const username = (profile && !profileError) ? profile.username : session.user.email;
                authButtonsDiv.innerHTML = `
                    <div class="user-status">
                        <span>Welcome, ${username}!</span>
                        <a href="#" id="logout-btn" class="logout-button btn">Logout</a>
                    </div>`;
                document.getElementById('logout-btn').addEventListener('click', async (e) => {
                    e.preventDefault();
                    await supabase.auth.signOut();
                    window.location.href = 'login.html';
                });
            } else {
                authButtonsDiv.innerHTML = `
                    <a href="login.html" class="btn">Login</a>
                    <a href="signup.html" class="btn">Signup</a>`;
            }
        }

        // Function to perform the search and load sets
        async function loadFlashcardSets(searchTerm = '', categoryFilter = 'All') {
            const searchResultsGrid = document.getElementById('search-results-grid');
            const setCountInfo = document.getElementById('set-count-info');
            searchResultsGrid.innerHTML = '<p>Loading sets...</p>'; // Show loading message

            let query = supabase
                .from('flashcard_sets')
                .select(`
                    id,
                    title,
                    category,
                    user_id,
                    profiles(username),     
                    flashcards(count)       
                `);

            if (searchTerm) {
                query = query.ilike('title', `%${searchTerm}%`); // Case-insensitive search by title
            }

            if (categoryFilter !== 'All') {
                query = query.eq('category', categoryFilter);
            }

            query = query.order('created_at', { ascending: false }); // Order by creation date

            const { data: sets, error } = await query;

            if (error) {
                console.error('Error fetching flashcard sets:', error.message);
                searchResultsGrid.innerHTML = '<p>Error loading sets. Please try again.</p>';
                setCountInfo.textContent = 'Error loading sets.';
                return;
            }

            searchResultsGrid.innerHTML = ''; // Clear loading message

            if (sets.length === 0) {
                searchResultsGrid.innerHTML = '<p>No sets found matching your criteria.</p>';
                setCountInfo.textContent = 'Showing 0 sets.';
                return;
            }

            setCountInfo.textContent = `Showing ${sets.length} sets.`;

            sets.forEach(set => {
                const termCount = set.flashcards[0] ? set.flashcards[0].count : 0;
                const creatorUsername = set.profiles ? set.profiles.username : 'Unknown';

                const setCard = document.createElement('div');
                setCard.className = 'set-card';
                setCard.innerHTML = `
                    <h3 class="set-title">${set.title}</h3>
                    <p class="set-category">${set.category || 'No Category'}</p>
                    <p class="set-view-prompt">Click to view flashcards in this set.</p>
                    <p class="set-terms">${termCount} Terms â€¢ By: ${creatorUsername}</p>
                    <div class="set-actions">
                        <button class="view-button" data-set-id="${set.id}">View</button>
                    </div>
                `;

                // Add event listener to the View button
                setCard.querySelector('.view-button').addEventListener('click', () => {
                    window.location.href = `flashcard_set.html?set_id=${set.id}`;
                });
                
                searchResultsGrid.appendChild(setCard);
            });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            updateAuthUI(); // Update login/signup status
            loadFlashcardSets(); // Load all sets initially

            document.getElementById('search-button').addEventListener('click', () => {
                const searchTerm = document.getElementById('search-input').value;
                const categoryFilter = document.querySelector('input[name="category-filter"]:checked').value;
                loadFlashcardSets(searchTerm, categoryFilter);
            });

            document.querySelectorAll('input[name="category-filter"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const searchTerm = document.getElementById('search-input').value;
                    const categoryFilter = document.querySelector('input[name="category-filter"]:checked').value;
                    loadFlashcardSets(searchTerm, categoryFilter);
                });
            });
        });

    </script>
</body>
</html>
